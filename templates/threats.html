{% extends 'layout.html' %}

{% block title %}Threat Detection{% endblock %}

{% block content %}
<div class="card">
  <h2><span class="material-icons" style="vertical-align: middle; margin-right: 0.5rem;">warning</span>Threat Detection Center</h2>
  <p style="color: var(--muted-foreground);">All incidents identified as threats by Gemini AI</p>
</div>

<!-- Threat Statistics -->
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
  <div class="card" style="text-align: center;">
    <div style="font-size: 2.5rem; font-weight: 700; color: var(--danger);" id="totalThreats">0</div>
    <div style="font-size: 0.875rem; color: var(--muted-foreground);">Total Threats</div>
  </div>
  <div class="card" style="text-align: center;">
    <div style="font-size: 2.5rem; font-weight: 700; color: var(--warning);" id="recentThreats">0</div>
    <div style="font-size: 0.875rem; color: var(--muted-foreground);">Last 24 Hours</div>
  </div>
  <div class="card" style="text-align: center;">
    <div style="font-size: 2.5rem; font-weight: 700; color: var(--primary);" id="avgConfidence">0%</div>
    <div style="font-size: 0.875rem; color: var(--muted-foreground);">Avg Confidence</div>
  </div>
  <div class="card" style="text-align: center;">
    <div style="font-size: 2.5rem; font-weight: 700; color: var(--success);" id="sessionsAffected">0</div>
    <div style="font-size: 0.875rem; color: var(--muted-foreground);">Sessions Affected</div>
  </div>
</div>

<!-- Filters -->
<div class="card">
  <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
    <div style="flex: 1; min-width: 200px;">
      <label style="font-size: 0.875rem; color: var(--muted-foreground); display: block; margin-bottom: 0.25rem;">Time Range</label>
      <select id="timeFilter" onchange="filterThreats()" style="width: 100%; padding: 0.5rem; border: 1px solid var(--border); border-radius: var(--radius); background: var(--background); color: var(--foreground);">
        <option value="all">All Time</option>
        <option value="24h">Last 24 Hours</option>
        <option value="7d">Last 7 Days</option>
        <option value="30d">Last 30 Days</option>
      </select>
    </div>
    <div style="flex: 1; min-width: 200px;">
      <label style="font-size: 0.875rem; color: var(--muted-foreground); display: block; margin-bottom: 0.25rem;">Confidence Level</label>
      <select id="confidenceFilter" onchange="filterThreats()" style="width: 100%; padding: 0.5rem; border: 1px solid var(--border); border-radius: var(--radius); background: var(--background); color: var(--foreground);">
        <option value="all">All Levels</option>
        <option value="high">High (>75%)</option>
        <option value="medium">Medium (50-75%)</option>
        <option value="low">Low (<50%)</option>
      </select>
    </div>
    <div style="flex: 1; min-width: 200px;">
      <label style="font-size: 0.875rem; color: var(--muted-foreground); display: block; margin-bottom: 0.25rem;">Sort By</label>
      <select id="sortFilter" onchange="filterThreats()" style="width: 100%; padding: 0.5rem; border: 1px solid var(--border); border-radius: var(--radius); background: var(--background); color: var(--foreground);">
        <option value="recent">Most Recent</option>
        <option value="confidence">Highest Confidence</option>
        <option value="duration">Longest Duration</option>
      </select>
    </div>
    <div style="display: flex; align-items: flex-end;">
      <button onclick="refreshThreats()" class="btn" style="padding: 0.5rem 1rem;">
        <span class="material-icons" style="vertical-align: middle; font-size: 1.2rem;">refresh</span>
        Refresh
      </button>
    </div>
  </div>
</div>

<!-- Threat List -->
<div id="threatsList">
  <!-- Threats will be populated by JavaScript -->
</div>

<!-- Incident Detail Modal -->
<div id="incidentModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; overflow: auto;">
  <div style="background: var(--background); margin: 2rem auto; max-width: 1100px; border-radius: var(--radius); border: 1px solid var(--border); box-shadow: 0 10px 40px rgba(0,0,0,0.5);">
    <div style="padding: 1.5rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;">
      <h3 style="margin: 0;"><span class="material-icons" style="vertical-align: middle; margin-right: 0.5rem;">warning</span>Threat Details</h3>
      <button onclick="closeIncidentModal()" style="background: none; border: none; cursor: pointer; padding: 0.5rem;">
        <span class="material-icons" style="color: var(--muted-foreground);">close</span>
      </button>
    </div>
    <div id="incidentModalContent" style="padding: 1.5rem; max-height: 70vh; overflow-y: auto;">
      Loading...
    </div>
  </div>
</div>

<script>
let allThreats = [];
let filteredThreats = [];

async function refreshThreats() {
  try {
    console.log('üîç Loading threats from API...');
    
    // First check database stats
    const statsResponse = await fetch('/api/database_stats');
    const statsData = await statsResponse.json();
    console.log('üìä Database Stats:', statsData);
    
    const response = await fetch('/api/threats');
    const data = await response.json();
    
    console.log('üì• Threats API Response:', data);
    
    if (data.error) {
      console.error('‚ùå Error loading threats:', data.error);
      document.getElementById('threatsList').innerHTML = `
        <div class="card" style="text-align: center; padding: 3rem; border: 2px solid var(--danger);">
          <span class="material-icons" style="font-size: 4rem; color: var(--danger);">error</span>
          <h3 style="margin-top: 1rem; color: var(--danger);">Error Loading Threats</h3>
          <p style="color: var(--muted-foreground);">${data.error}</p>
        </div>
      `;
      return;
    }
    
    allThreats = data.threats || [];
    console.log(`‚úÖ Loaded ${allThreats.length} threats`);
    
    if (allThreats.length > 0) {
      console.log('Sample threat:', allThreats[0]);
    }
    
    updateStatistics();
    filterThreats();
  } catch (error) {
    console.error('‚ùå Error fetching threats:', error);
    document.getElementById('threatsList').innerHTML = `
      <div class="card" style="text-align: center; padding: 3rem; border: 2px solid var(--danger);">
        <span class="material-icons" style="font-size: 4rem; color: var(--danger);">error</span>
        <h3 style="margin-top: 1rem; color: var(--danger);">Network Error</h3>
        <p style="color: var(--muted-foreground);">${error.message}</p>
      </div>
    `;
  }
}

function updateStatistics() {
  const now = Date.now();
  const last24h = now - (24 * 60 * 60 * 1000);
  
  document.getElementById('totalThreats').textContent = allThreats.length;
  
  const recentThreats = allThreats.filter(t => 
    new Date(t.started_at).getTime() > last24h
  );
  document.getElementById('recentThreats').textContent = recentThreats.length;
  
  const avgConf = allThreats.length > 0 ? 
    allThreats.reduce((sum, t) => sum + (t.threat_confidence || 0), 0) / allThreats.length * 100 : 0;
  document.getElementById('avgConfidence').textContent = `${Math.round(avgConf)}%`;
  
  const uniqueSessions = new Set(allThreats.map(t => t.session_id));
  document.getElementById('sessionsAffected').textContent = uniqueSessions.size;
}

function filterThreats() {
  const timeFilter = document.getElementById('timeFilter').value;
  const confidenceFilter = document.getElementById('confidenceFilter').value;
  const sortFilter = document.getElementById('sortFilter').value;
  
  filteredThreats = allThreats.filter(threat => {
    // Time filter
    if (timeFilter !== 'all') {
      const threatTime = new Date(threat.started_at).getTime();
      const now = Date.now();
      const cutoff = {
        '24h': now - (24 * 60 * 60 * 1000),
        '7d': now - (7 * 24 * 60 * 60 * 1000),
        '30d': now - (30 * 24 * 60 * 60 * 1000)
      }[timeFilter];
      
      if (threatTime < cutoff) return false;
    }
    
    // Confidence filter
    if (confidenceFilter !== 'all') {
      const conf = (threat.threat_confidence || 0) * 100;
      if (confidenceFilter === 'high' && conf <= 75) return false;
      if (confidenceFilter === 'medium' && (conf <= 50 || conf > 75)) return false;
      if (confidenceFilter === 'low' && conf >= 50) return false;
    }
    
    return true;
  });
  
  // Sort threats
  filteredThreats.sort((a, b) => {
    if (sortFilter === 'recent') {
      return new Date(b.started_at) - new Date(a.started_at);
    } else if (sortFilter === 'confidence') {
      return (b.threat_confidence || 0) - (a.threat_confidence || 0);
    } else if (sortFilter === 'duration') {
      const aDur = a.ended_at ? 
        (new Date(a.ended_at) - new Date(a.started_at)) : 
        (Date.now() - new Date(a.started_at).getTime());
      const bDur = b.ended_at ? 
        (new Date(b.ended_at) - new Date(b.started_at)) : 
        (Date.now() - new Date(b.started_at).getTime());
      return bDur - aDur;
    }
    return 0;
  });
  
  renderThreats();
}

function renderThreats() {
  const container = document.getElementById('threatsList');
  
  if (filteredThreats.length === 0) {
    container.innerHTML = `
      <div class="card" style="text-align: center; padding: 3rem;">
        <span class="material-icons" style="font-size: 4rem; color: var(--muted-foreground); opacity: 0.5;">check_circle</span>
        <h3 style="margin-top: 1rem; color: var(--muted-foreground);">No Threats Detected</h3>
        <p style="color: var(--muted-foreground);">All incidents have been classified as safe</p>
      </div>
    `;
    return;
  }
  
  container.innerHTML = filteredThreats.map(threat => {
    const duration = threat.ended_at ? 
      (new Date(threat.ended_at) - new Date(threat.started_at)) / 1000 : 
      (Date.now() - new Date(threat.started_at).getTime()) / 1000;
    const durationText = duration > 60 ? 
      `${Math.floor(duration / 60)}m ${Math.floor(duration % 60)}s` : 
      `${Math.floor(duration)}s`;
    
    const confidence = (threat.threat_confidence || 0) * 100;
    const confidenceColor = confidence > 75 ? 'var(--danger)' : confidence > 50 ? 'var(--warning)' : 'var(--muted-foreground)';
    
    return `
      <div class="card" style="border-left: 4px solid var(--danger); margin-bottom: 1rem;">
        <div style="display: flex; justify-content: between; align-items: flex-start; gap: 2rem;">
          <div style="flex: 1;">
            <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
              <h3 style="margin: 0;">Incident #${threat.id}</h3>
              <span class="status" style="background: ${confidenceColor} !important; color: white !important;">
                ${confidence.toFixed(0)}% Confidence
              </span>
              <span class="status monitoring">Session #${threat.session_id}</span>
            </div>
            
            <div style="background: rgba(239, 68, 68, 0.1); border: 1px solid var(--danger); padding: 1rem; border-radius: var(--radius); margin-bottom: 1rem;">
              <div style="font-weight: 600; color: var(--danger); margin-bottom: 0.5rem;">
                <span class="material-icons" style="vertical-align: middle; font-size: 1rem;">warning</span>
                Threat Analysis
              </div>
              <div style="color: var(--foreground);">${threat.threat_explanation || 'No explanation provided'}</div>
            </div>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
              <div>
                <div style="font-size: 0.75rem; color: var(--muted-foreground); text-transform: uppercase; margin-bottom: 0.25rem;">Time</div>
                <div style="font-weight: 600;">${new Date(threat.started_at).toLocaleString()}</div>
              </div>
              <div>
                <div style="font-size: 0.75rem; color: var(--muted-foreground); text-transform: uppercase; margin-bottom: 0.25rem;">Duration</div>
                <div style="font-weight: 600;">${durationText}</div>
              </div>
              <div>
                <div style="font-size: 0.75rem; color: var(--muted-foreground); text-transform: uppercase; margin-bottom: 0.25rem;">Frames</div>
                <div style="font-weight: 600;">${threat.total_frames || 0}</div>
              </div>
              <div>
                <div style="font-size: 0.75rem; color: var(--muted-foreground); text-transform: uppercase; margin-bottom: 0.25rem;">Max Hands</div>
                <div style="font-weight: 600;">${threat.max_hand_count || 0}</div>
              </div>
              <div>
                <div style="font-size: 0.75rem; color: var(--muted-foreground); text-transform: uppercase; margin-bottom: 0.25rem;">Detection Confidence</div>
                <div style="font-weight: 600;">${(threat.max_confidence * 100).toFixed(1)}%</div>
              </div>
            </div>
            
            ${threat.analyses && threat.analyses.length > 0 ? `
              <div style="margin-top: 1rem;">
                <div style="font-size: 0.875rem; font-weight: 600; color: var(--muted-foreground); margin-bottom: 0.5rem;">
                  Gemini Analyses (${threat.analyses.length})
                </div>
                <div style="display: grid; gap: 0.5rem;">
                  ${threat.analyses.map((analysis, idx) => `
                    <div style="background: var(--muted); padding: 0.75rem; border-radius: var(--radius); font-size: 0.875rem;">
                      <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                        <strong>Analysis #${idx + 1}</strong>
                        <span style="color: var(--danger);">${(analysis.confidence * 100).toFixed(1)}%</span>
                      </div>
                      <div>Frames ${analysis.frame_start}-${analysis.frame_end} (${analysis.total_frames_analyzed} frames)</div>
                      ${analysis.explanation ? `<div style="margin-top: 0.5rem; font-style: italic;">"${analysis.explanation}"</div>` : ''}
                    </div>
                  `).join('')}
                </div>
              </div>
            ` : ''}
            
            <div style="margin-top: 1rem;">
              <button class="btn" onclick="viewIncident(${threat.id})" style="width: 100%;">
                <span class="material-icons" style="vertical-align: middle; font-size: 1rem; margin-right: 0.25rem;">visibility</span>
                View Full Incident Details
              </button>
            </div>
          </div>
          
          ${threat.sample_frame ? `
            <div style="flex-shrink: 0;">
              <div style="font-size: 0.75rem; color: var(--muted-foreground); text-transform: uppercase; margin-bottom: 0.5rem;">Sample Frame</div>
              <img src="data:image/jpeg;base64,${threat.sample_frame}" 
                   style="width: 200px; height: auto; border-radius: var(--radius); border: 2px solid var(--danger); cursor: pointer;"
                   onclick="viewFrameImage('${threat.sample_frame}', ${threat.id})"
                   alt="Threat sample">
            </div>
          ` : ''}
        </div>
      </div>
    `;
  }).join('');
}

async function viewIncident(incidentId) {
  try {
    const modal = document.getElementById('incidentModal');
    const content = document.getElementById('incidentModalContent');
    
    modal.style.display = 'block';
    content.innerHTML = '<div style="text-align: center; padding: 2rem;">Loading...</div>';
    
    const response = await fetch(`/api/incidents/${incidentId}`);
    const data = await response.json();
    
    if (data.error) {
      content.innerHTML = `<div style="color: var(--danger);">Error: ${data.error}</div>`;
      return;
    }
    
    const incident = data.incident;
    const duration = incident.ended_at ? 
      (new Date(incident.ended_at) - new Date(incident.started_at)) / 1000 : 
      (Date.now() - new Date(incident.started_at).getTime()) / 1000;
    const durationText = duration > 60 ? 
      `${Math.floor(duration / 60)}m ${Math.floor(duration % 60)}s` : 
      `${Math.floor(duration)}s`;
    
    content.innerHTML = `
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
        <div style="background: var(--muted); padding: 1rem; border-radius: var(--radius);">
          <div style="font-size: 0.875rem; color: var(--muted-foreground); margin-bottom: 0.25rem;">Incident ID</div>
          <div style="font-size: 1.5rem; font-weight: 700;">#${incident.id}</div>
        </div>
        <div style="background: var(--muted); padding: 1rem; border-radius: var(--radius);">
          <div style="font-size: 0.875rem; color: var(--muted-foreground); margin-bottom: 0.25rem;">Duration</div>
          <div style="font-size: 1.5rem; font-weight: 700;">${durationText}</div>
        </div>
        <div style="background: var(--muted); padding: 1rem; border-radius: var(--radius);">
          <div style="font-size: 0.875rem; color: var(--muted-foreground); margin-bottom: 0.25rem;">Total Frames</div>
          <div style="font-size: 1.5rem; font-weight: 700;">${incident.total_frames}</div>
        </div>
        <div style="background: var(--muted); padding: 1rem; border-radius: var(--radius);">
          <div style="font-size: 0.875rem; color: var(--muted-foreground); margin-bottom: 0.25rem;">Max Hands</div>
          <div style="font-size: 1.5rem; font-weight: 700;">${incident.max_hand_count}</div>
        </div>
        <div style="background: var(--muted); padding: 1rem; border-radius: var(--radius);">
          <div style="font-size: 0.875rem; color: var(--muted-foreground); margin-bottom: 0.25rem;">Max Confidence</div>
          <div style="font-size: 1.5rem; font-weight: 700;">${(incident.max_confidence * 100).toFixed(1)}%</div>
        </div>
        <div style="background: var(--muted); padding: 1rem; border-radius: var(--radius);">
          <div style="font-size: 0.875rem; color: var(--muted-foreground); margin-bottom: 0.25rem;">Status</div>
          <div style="font-size: 1.25rem; font-weight: 700;">
            <span class="status" style="background: #ef4444 !important; color: white !important; border-color: #dc2626 !important;">THREAT</span>
          </div>
        </div>
      </div>
      
      ${incident.threat_detected ? `
        <div style="background: rgba(239, 68, 68, 0.1); border: 1px solid var(--danger); padding: 1rem; border-radius: var(--radius); margin-bottom: 1.5rem;">
          <div style="font-weight: 700; color: var(--danger); margin-bottom: 0.5rem;">
            <span class="material-icons" style="vertical-align: middle; font-size: 1.2rem;">warning</span>
            Threat Detected (${(incident.threat_confidence * 100).toFixed(1)}% confidence)
          </div>
          <div style="color: var(--danger);">${incident.threat_explanation || 'No explanation provided'}</div>
        </div>
      ` : ''}
      
      <h4 style="margin-top: 1.5rem; margin-bottom: 1rem;">Gemini Analyses (${(incident.analyses || []).length})</h4>
      ${(incident.analyses || []).length === 0 ? 
        '<div style="text-align: center; padding: 1rem; color: var(--muted-foreground); background: var(--muted); border-radius: var(--radius);">No Gemini analyses performed</div>' :
        `<div style="display: grid; gap: 1rem; margin-bottom: 1.5rem;">
          ${incident.analyses.map((analysis, idx) => {
            const analysisFrames = incident.frames.filter(f => 
              f.frame_number >= analysis.frame_start && f.frame_number <= analysis.frame_end && f.frame_image
            );
            
            return `
            <div style="background: var(--muted); padding: 1rem; border-radius: var(--radius); border-left: 3px solid ${analysis.threat_detected ? '#ef4444' : '#22c55e'};">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                <strong>Analysis #${idx + 1}</strong>
                <span class="status" style="background: #ef4444 !important; color: white !important; border-color: #dc2626 !important;">THREAT</span>
              </div>
              <div style="font-size: 0.875rem; margin-bottom: 0.5rem;">
                <span style="color: var(--muted-foreground);">Frames:</span> ${analysis.frame_start} - ${analysis.frame_end} (${analysis.total_frames_analyzed} frames)
              </div>
              <div style="font-size: 0.875rem; margin-bottom: 0.5rem;">
                <span style="color: var(--muted-foreground);">Confidence:</span> ${(analysis.confidence * 100).toFixed(1)}% | 
                <span style="color: var(--muted-foreground);">Latency:</span> ${analysis.api_latency_ms}ms
              </div>
              ${analysis.explanation ? `<div style="margin-top: 0.5rem; padding: 0.5rem; background: var(--background); border-radius: var(--radius); font-size: 0.875rem;">${analysis.explanation}</div>` : ''}
              
              ${analysisFrames.length > 0 ? `
                <div style="margin-top: 1rem;">
                  <div style="font-size: 0.875rem; color: var(--muted-foreground); margin-bottom: 0.5rem;">
                    ‚ö†Ô∏è Offending Images:
                  </div>
                  <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 0.5rem;">
                    ${analysisFrames.slice(0, 10).map(frame => `
                      <div style="background: var(--background); border: 2px solid var(--danger); border-radius: var(--radius); overflow: hidden; cursor: pointer;" onclick="viewFrameImage('${frame.frame_image}', ${frame.frame_number})">
                        <img src="data:image/jpeg;base64,${frame.frame_image}" style="width: 100%; height: auto; display: block;" alt="Frame ${frame.frame_number}">
                        <div style="padding: 0.25rem; text-align: center; font-size: 0.75rem; background: var(--danger); color: white;">
                          Frame #${frame.frame_number}
                        </div>
                      </div>
                    `).join('')}
                  </div>
                </div>
              ` : ''}
            </div>
            `;
          }).join('')}
        </div>`
      }
      
      ${(incident.alerts || []).length > 0 ? `
        <h4 style="margin-top: 1.5rem; margin-bottom: 1rem;">Alerts (${incident.alerts.length})</h4>
        <div style="display: grid; gap: 0.5rem;">
          ${incident.alerts.map(alert => `
            <div style="background: var(--muted); padding: 0.75rem; border-radius: var(--radius); display: flex; justify-content: space-between; align-items: center;">
              <div>
                <strong>${alert.alert_type}</strong>
                <div style="font-size: 0.875rem; color: var(--muted-foreground);">${new Date(alert.sent_at).toLocaleString()}</div>
                ${alert.message ? `<div style="font-size: 0.875rem; margin-top: 0.25rem;">${alert.message}</div>` : ''}
              </div>
              <div style="text-align: right; font-size: 0.75rem;">
                ${alert.audio_played ? '<span class="status detected">Audio</span>' : ''}
                ${alert.notification_sent ? '<span class="status detected">Notif</span>' : ''}
              </div>
            </div>
          `).join('')}
        </div>
      ` : ''}
    `;
  } catch (error) {
    console.error('Error loading incident:', error);
    content.innerHTML = `<div style="color: var(--danger);">Error loading incident: ${error.message}</div>`;
  }
}

function closeIncidentModal() {
  document.getElementById('incidentModal').style.display = 'none';
}

function viewFrameImage(base64Image, frameNumber) {
  const modal = document.createElement('div');
  modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 2000; display: flex; align-items: center; justify-content: center; cursor: pointer;';
  modal.onclick = () => modal.remove();
  
  const container = document.createElement('div');
  container.style.cssText = 'max-width: 90%; max-height: 90%; text-align: center;';
  container.onclick = (e) => e.stopPropagation();
  
  const img = document.createElement('img');
  img.src = `data:image/jpeg;base64,${base64Image}`;
  img.style.cssText = 'max-width: 100%; max-height: 80vh; border-radius: var(--radius); box-shadow: 0 20px 60px rgba(0,0,0,0.8);';
  
  const caption = document.createElement('div');
  caption.textContent = `Frame #${frameNumber}`;
  caption.style.cssText = 'color: white; font-size: 1.2rem; font-weight: 600; margin-top: 1rem;';
  
  const closeBtn = document.createElement('button');
  closeBtn.textContent = 'Close';
  closeBtn.style.cssText = 'margin-top: 1rem; padding: 0.5rem 1.5rem; background: var(--danger); color: white; border: none; border-radius: var(--radius); cursor: pointer; font-weight: 600;';
  closeBtn.onclick = () => modal.remove();
  
  container.appendChild(img);
  container.appendChild(caption);
  container.appendChild(closeBtn);
  modal.appendChild(container);
  document.body.appendChild(modal);
}

// Close modal when clicking outside
document.addEventListener('click', function(event) {
  const modal = document.getElementById('incidentModal');
  if (event.target === modal) {
    closeIncidentModal();
  }
});

// Initialize
refreshThreats();

// Auto-refresh every 10 seconds
setInterval(refreshThreats, 10000);
</script>
{% endblock %}

