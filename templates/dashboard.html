{% extends 'layout.html' %}

{% block title %}Live Monitor{% endblock %}

{% block content %}
<div class="card">
  <h2><span class="material-icons" style="vertical-align: middle; margin-right: 0.5rem;">shield</span>Live Monitoring System</h2>
  <p style="color: var(--muted-foreground);">AI-powered security detection with real-time analysis</p>
</div>

<!-- Force horizontal layout with flexbox -->
<div style="display: flex !important; flex-direction: row !important; gap: 2rem !important; margin-bottom: 2rem !important; width: 100% !important;">
  
  <!-- Left Side: Monitoring Controls -->
  <div style="flex: 1 !important; display: flex !important; flex-direction: column !important; gap: 1.5rem !important; min-width: 0 !important;">
    <div class="card">
      <h3><span class="material-icons" style="vertical-align: middle; margin-right: 0.5rem;">settings</span>Monitoring Controls</h3>
      <div class="controls">
        <button id="startBtn" onclick="startMonitoring()">Start Monitoring</button>
        <button id="stopBtn" onclick="stopMonitoring()" class="danger">Stop Monitoring</button>
        <div id="status" class="status stopped">Status: Stopped</div>
      </div>
    </div>
    
    <!-- Current Session Live Stats -->
    <div class="card" id="liveSessionStats" style="display: none;">
      <h3><span class="material-icons" style="vertical-align: middle; margin-right: 0.5rem;">show_chart</span>Live Session Analytics</h3>
      <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin-top: 1rem;">
        <div style="background: var(--muted); padding: 1rem; border-radius: var(--radius); text-align: center;">
          <div style="font-size: 2rem; font-weight: 700; color: var(--primary);" id="liveFrameCount">0</div>
          <div style="font-size: 0.875rem; color: var(--muted-foreground);">Frames Processed</div>
        </div>
        <div style="background: var(--muted); padding: 1rem; border-radius: var(--radius); text-align: center;">
          <div style="font-size: 2rem; font-weight: 700; color: var(--warning);" id="liveIncidentCount">0</div>
          <div style="font-size: 0.875rem; color: var(--muted-foreground);">Incidents</div>
        </div>
        <div style="background: var(--muted); padding: 1rem; border-radius: var(--radius); text-align: center;">
          <div style="font-size: 2rem; font-weight: 700; color: var(--danger);" id="liveEscalationCount">0</div>
          <div style="font-size: 0.875rem; color: var(--muted-foreground);">Escalations</div>
        </div>
        <div style="background: var(--muted); padding: 1rem; border-radius: var(--radius); text-align: center;">
          <div style="font-size: 2rem; font-weight: 700; color: var(--success);" id="liveDuration">0s</div>
          <div style="font-size: 0.875rem; color: var(--muted-foreground);">Duration</div>
        </div>
      </div>
      <div style="margin-top: 1.5rem;">
        <canvas id="liveIncidentChart" style="max-height: 150px;"></canvas>
      </div>
    </div>

    <div class="realtime-results" id="realtimeResults" style="display: none;">
      <h3>Real-Time Analysis Results</h3>
      <div class="result-card">
        <div class="result-header">
          <span id="photoCount">Photo #0</span>
          <span id="resultTimestamp">--:--:--</span>
        </div>
        <div class="result-content">
          <div class="result-item">
            <span class="label">Hand Detection:</span>
            <span id="handDetection" class="status unknown">Unknown</span>
          </div>
          <div class="result-item">
            <span class="label">Hand Count:</span>
            <span id="handCount">0</span>
          </div>
          <div class="result-item">
            <span class="label">Hand Confidence:</span>
            <span id="handConfidence">0%</span>
          </div>
          <div class="result-item">
            <span class="label">Hand Positions:</span>
            <span id="handPositions">None</span>
          </div>
          <div class="result-item">
            <span class="label">Theft Analysis:</span>
            <span id="theftAnalysis" class="status unknown">Unknown</span>
          </div>
          <div class="result-item">
            <span class="label">Theft Confidence:</span>
            <span id="theftConfidence">0%</span>
          </div>
          <div class="result-item">
            <span class="label">Explanation:</span>
            <span id="explanation">No analysis yet</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Right Side: Video Stream -->
  <div style="flex: 1 !important; display: flex !important; flex-direction: column !important; min-width: 0 !important;">
    <div class="card video-container">
      <h3><span class="material-icons" style="vertical-align: middle; margin-right: 0.5rem;">videocam</span>Live Detection Stream</h3>
      <div id="detectionFeed">
        <img id="detectionStream" src="/detection_stream" alt="Hand Detection Feed">
        <canvas id="detectionOverlay"></canvas>
        <div id="streamStatus">
          <span id="streamIndicator" class="status not-detected">Stream: Loading...</span>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Current Session Info -->
<div class="card" id="currentSessionCard" style="display: none;">
  <h3><span class="material-icons" style="vertical-align: middle; margin-right: 0.5rem;">video_library</span>Current Session</h3>
  <div id="currentSessionInfo" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-top: 1rem;">
    <!-- Session info will be populated by JavaScript -->
  </div>
</div>

<!-- Sessions & Incidents Table -->
<div class="card audit-section">
  <h3><span class="material-icons" style="vertical-align: middle; margin-right: 0.5rem;">assessment</span>Sessions & Incidents</h3>
  <div class="table-controls">
    <div class="table-filters">
      <select id="sessionFilter" onchange="filterSessions()">
        <option value="">All Sessions</option>
        <option value="active">Active</option>
        <option value="completed">Completed</option>
      </select>
      <select id="threatFilter" onchange="filterSessions()">
        <option value="">All Threats</option>
        <option value="threat">Threat Detected</option>
        <option value="safe">Safe</option>
      </select>
      <input type="date" id="dateFilter" onchange="filterSessions()" placeholder="Filter by date">
    </div>
    <div class="table-actions">
      <button onclick="refreshSessions()" class="btn">Refresh</button>
    </div>
  </div>
  <div class="table-container">
    <table id="sessionsTable" class="audit-table">
      <thead>
        <tr>
          <th>Session ID</th>
          <th>Started</th>
          <th>Duration</th>
          <th>Frames</th>
          <th>Incidents</th>
          <th>Escalations</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="sessionsTableBody">
        <!-- Session rows will be populated by JavaScript -->
      </tbody>
    </table>
  </div>
  <div class="table-pagination">
    <button onclick="previousSessionPage()" id="sessionPrevBtn" disabled>Previous</button>
    <span id="sessionPageInfo">Page 1 of 1</span>
    <button onclick="nextSessionPage()" id="sessionNextBtn" disabled>Next</button>
  </div>
</div>

<!-- Session Detail Modal -->
<div id="sessionModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; overflow: auto;">
  <div style="background: var(--background); margin: 2rem auto; max-width: 900px; border-radius: var(--radius); border: 1px solid var(--border); box-shadow: 0 10px 40px rgba(0,0,0,0.5);">
    <div style="padding: 1.5rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;">
      <h3 style="margin: 0;"><span class="material-icons" style="vertical-align: middle; margin-right: 0.5rem;">video_library</span>Session Details</h3>
      <button onclick="closeSessionModal()" style="background: none; border: none; cursor: pointer; padding: 0.5rem;">
        <span class="material-icons" style="color: var(--muted-foreground);">close</span>
      </button>
    </div>
    <div id="sessionModalContent" style="padding: 1.5rem; max-height: 70vh; overflow-y: auto;">
      Loading...
    </div>
  </div>
</div>

<!-- Incident Detail Modal -->
<div id="incidentModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; overflow: auto;">
  <div style="background: var(--background); margin: 2rem auto; max-width: 1100px; border-radius: var(--radius); border: 1px solid var(--border); box-shadow: 0 10px 40px rgba(0,0,0,0.5);">
    <div style="padding: 1.5rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;">
      <h3 style="margin: 0;"><span class="material-icons" style="vertical-align: middle; margin-right: 0.5rem;">warning</span>Incident Details</h3>
      <button onclick="closeIncidentModal()" style="background: none; border: none; cursor: pointer; padding: 0.5rem;">
        <span class="material-icons" style="color: var(--muted-foreground);">close</span>
      </button>
    </div>
    <div id="incidentModalContent" style="padding: 1.5rem; max-height: 70vh; overflow-y: auto;">
      Loading...
    </div>
  </div>
</div>
<script src="{{ url_for('static', filename='audit-table.js') }}"></script>
<script src="{{ url_for('static', filename='dashboard-monitoring.js') }}"></script>
{% endblock %}
