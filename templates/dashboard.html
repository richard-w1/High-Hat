{% extends 'layout.html' %}

{% block title %}Live Monitor - M.O.N.K.Y{% endblock %}

{% block content %}
<div class="card">
  <h2>üõ°Ô∏è Live Monitoring System</h2>
  <p style="color: var(--muted-foreground);">AI-powered theft detection with Gemini, YOLO, and ElevenLabs</p>
</div>

<div class="card">
  <h3>Monitoring Controls</h3>
  <div class="controls">
    <button id="startBtn" onclick="startMonitoring()">Start Monitoring</button>
    <button id="stopBtn" onclick="stopMonitoring()" class="danger">Stop Monitoring</button>
    <button onclick="refreshData()">Refresh Data</button>
    <button onclick="testIncident()" class="success">Test Incident</button>
    <button onclick="testHandDetection()" class="info">Test Hand Detection</button>
    <button onclick="testGemini()" class="info">Test Gemini</button>
    <button onclick="testAudio()" class="info">Test Audio</button>
    <div id="status" class="status stopped">Status: Stopped</div>
  </div>
</div>

<div class="card video-container">
  <h3>üéØ Live YOLO Detection Stream</h3>
  <div id="yoloFeed">
    <img id="yoloStream" src="/yolo_stream" alt="YOLO Detection Feed">
    <canvas id="detectionOverlay"></canvas>
    <div id="streamStatus">
      <span id="streamIndicator" class="status not-detected">Stream: Loading...</span>
    </div>
  </div>
</div>

<div class="realtime-results" id="realtimeResults" style="display: none;">
  <h3>Real-Time Analysis Results</h3>
  <div class="result-card">
    <div class="result-header">
      <span id="photoCount">Photo #0</span>
      <span id="resultTimestamp">--:--:--</span>
    </div>
    <div class="result-content">
      <div class="result-item">
        <span class="label">Hand Detection:</span>
        <span id="handDetection" class="status unknown">Unknown</span>
      </div>
      <div class="result-item">
        <span class="label">Hand Count:</span>
        <span id="handCount">0</span>
      </div>
      <div class="result-item">
        <span class="label">Hand Confidence:</span>
        <span id="handConfidence">0%</span>
      </div>
      <div class="result-item">
        <span class="label">Hand Positions:</span>
        <span id="handPositions">None</span>
      </div>
      <div class="result-item">
        <span class="label">Theft Analysis:</span>
        <span id="theftAnalysis" class="status unknown">Unknown</span>
      </div>
      <div class="result-item">
        <span class="label">Theft Confidence:</span>
        <span id="theftConfidence">0%</span>
      </div>
      <div class="result-item">
        <span class="label">Explanation:</span>
        <span id="explanation">No analysis yet</span>
      </div>
    </div>
  </div>
</div>

<div class="debug-info">
  <h4>üîç Debug Information</h4>
  <div id="debugStatus">
    <p><strong>Dashboard Updates:</strong> Every 5 seconds</p>
    <p><strong>Photo Frequency:</strong> Every 1 second (when monitoring)</p>
    <p><strong>Last Update:</strong> <span id="lastUpdateTime">Never</span></p>
    <p><strong>API Status:</strong> <span id="apiStatus">Unknown</span></p>
  </div>
</div>

<div class="card">
  <h3>Recent Incidents</h3>
  <div id="incidentsList">
    <p>No incidents recorded yet.</p>
  </div>
</div>

<script>
let isMonitoring = false;

async function startMonitoring() {
  try {
    const response = await fetch('/api/start_monitoring', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' }
    });
    const data = await response.json();
    
    if (data.status === 'success') {
      isMonitoring = true;
      updateStatus('Monitoring', 'monitoring');
      document.getElementById('startBtn').disabled = true;
      document.getElementById('stopBtn').disabled = false;
    } else {
      alert('Error: ' + data.message);
    }
  } catch (error) {
    alert('Error starting monitoring: ' + error.message);
  }
}

async function stopMonitoring() {
  try {
    const response = await fetch('/api/stop_monitoring', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' }
    });
    const data = await response.json();
    
    if (data.status === 'success') {
      isMonitoring = false;
      updateStatus('Stopped', 'stopped');
      document.getElementById('startBtn').disabled = false;
      document.getElementById('stopBtn').disabled = true;
    }
  } catch (error) {
    alert('Error stopping monitoring: ' + error.message);
  }
}

function updateStatus(text, className) {
  const statusDiv = document.getElementById('status');
  statusDiv.textContent = 'Status: ' + text;
  statusDiv.className = 'status ' + className;
}

async function testIncident() {
  try {
    const response = await fetch('/api/test_incident', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' }
    });
    const data = await response.json();
    alert('Test incident: ' + data.message);
    refreshData();
  } catch (error) {
    alert('Error creating test incident: ' + error.message);
  }
}

async function testHandDetection() {
  try {
    const response = await fetch('/api/test_hand_detection', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' }
    });
    const data = await response.json();
    alert('Hand detection test: ' + data.message);
  } catch (error) {
    alert('Error testing hand detection: ' + error.message);
  }
}

async function testGemini() {
  try {
    const response = await fetch('/api/test_gemini', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' }
    });
    const data = await response.json();
    alert('Gemini test: ' + data.message);
  } catch (error) {
    alert('Error testing Gemini: ' + error.message);
  }
}

async function testAudio() {
  try {
    const response = await fetch('/api/test_audio', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' }
    });
    const data = await response.json();
    alert('Audio test: ' + data.message);
  } catch (error) {
    alert('Error testing audio: ' + error.message);
  }
}

async function refreshData() {
  try {
    console.log('[v0] Refreshing dashboard data...');
    
    document.getElementById('lastUpdateTime').textContent = new Date().toLocaleTimeString();
    document.getElementById('apiStatus').textContent = 'Fetching...';
    
    const incidentsResponse = await fetch('/api/incidents');
    const incidentsData = await incidentsResponse.json();
    displayIncidents(incidentsData.incidents);

    const sessionResponse = await fetch('/api/session');
    const sessionData = await sessionResponse.json();
    console.log('[v0] Session data:', sessionData);
    
    if (sessionData.session && sessionData.session.is_active) {
      isMonitoring = true;
      updateStatus('Monitoring', 'monitoring');
      document.getElementById('startBtn').disabled = true;
      document.getElementById('stopBtn').disabled = false;
      
      document.getElementById('realtimeResults').style.display = 'block';
      
      console.log('[v0] Fetching latest results...');
      const resultsResponse = await fetch('/api/latest_results');
      const resultsData = await resultsResponse.json();
      console.log('[v0] Latest results:', resultsData);
      updateRealtimeResults(resultsData.results);
      
      console.log('[v0] Fetching detailed hand detection data...');
      const handResponse = await fetch('/api/hand_detection_data');
      const handData = await handResponse.json();
      console.log('[v0] Hand detection data:', handData);
      updateHandDetectionDisplay(handData);
      
      console.log('[v0] Fetching YOLO visualized image...');
      const imageResponse = await fetch('/api/visualized_image');
      const imageData = await imageResponse.json();
      updateYOLOFeed(imageData);
      
      document.getElementById('apiStatus').textContent = 'Connected';
    } else {
      document.getElementById('realtimeResults').style.display = 'none';
      console.log('[v0] Not monitoring, hiding real-time results');
      document.getElementById('apiStatus').textContent = 'Not monitoring';
    }
  } catch (error) {
    console.error('[v0] Error refreshing data:', error);
    document.getElementById('apiStatus').textContent = 'Error: ' + error.message;
  }
}

function updateRealtimeResults(results) {
  if (!results) {
    console.log('[v0] No results to update');
    return;
  }
  
  console.log('[v0] Updating real-time results:', results);
  
  document.getElementById('photoCount').textContent = `Photo #${results.photo_count}`;
  console.log(`[v0] Updated photo count to #${results.photo_count}`);
  
  if (results.timestamp) {
    const date = new Date(results.timestamp * 1000);
    document.getElementById('resultTimestamp').textContent = date.toLocaleTimeString();
    console.log(`[v0] Updated timestamp to ${date.toLocaleTimeString()}`);
  }
  
  const handDetection = document.getElementById('handDetection');
  if (results.hands_detected) {
    handDetection.textContent = 'Detected';
    handDetection.className = 'status detected';
    console.log('[v0] Hands detected');
  } else {
    handDetection.textContent = 'Not Detected';
    handDetection.className = 'status not-detected';
    console.log('[v0] No hands detected');
  }
  
  document.getElementById('handCount').textContent = results.hand_count || 0;
  console.log(`[v0] Hand count: ${results.hand_count || 0}`);
  
  document.getElementById('handConfidence').textContent = `${Math.round(results.hand_confidence)}%`;
  console.log(`[v0] Hand confidence: ${Math.round(results.hand_confidence)}%`);
  
  const handPositions = results.hand_positions || [];
  if (handPositions.length > 0) {
    const positionText = handPositions.map((pos, index) => 
      `Hand ${index + 1}: (${pos[0]}, ${pos[1]}, ${pos[2]}, ${pos[3]})`
    ).join('; ');
    document.getElementById('handPositions').textContent = positionText;
  } else {
    document.getElementById('handPositions').textContent = 'None';
  }
  console.log(`[v0] Hand positions: ${handPositions.length} detected`);
  
  const theftAnalysis = document.getElementById('theftAnalysis');
  if (results.theft_detected) {
    theftAnalysis.textContent = 'Suspicious';
    theftAnalysis.className = 'status detected';
    console.log('[v0] Theft detected');
  } else {
    theftAnalysis.textContent = 'Safe';
    theftAnalysis.className = 'status not-detected';
    console.log('[v0] No theft detected');
  }
  
  document.getElementById('theftConfidence').textContent = `${Math.round(results.theft_confidence)}%`;
  console.log(`[v0] Theft confidence: ${Math.round(results.theft_confidence)}%`);
  
  document.getElementById('explanation').textContent = results.explanation || 'No analysis yet';
  console.log(`[v0] Explanation: ${results.explanation || 'No analysis yet'}`);
}

function updateYOLOFeed(imageData) {
  console.log('[v0] YOLO feed is now handled by direct MJPEG stream');
}

function updateHandDetectionDisplay(handData) {
  console.log('[v0] Updating hand detection display with:', handData);
  
  const handDetection = document.getElementById('handDetection');
  if (handData.hands_detected) {
    handDetection.textContent = 'Detected';
    handDetection.className = 'status detected';
  } else {
    handDetection.textContent = 'Not Detected';
    handDetection.className = 'status not-detected';
  }
  
  document.getElementById('handCount').textContent = handData.hand_count || 0;
  document.getElementById('handConfidence').textContent = `${Math.round(handData.hand_confidence || 0)}%`;
  
  const handPositions = handData.hand_positions || [];
  if (handPositions.length > 0) {
    const positionText = handPositions.map((pos, index) => 
      `Hand ${index + 1}: (${pos[0]}, ${pos[1]}, ${pos[2]}, ${pos[3]})`
    ).join('; ');
    document.getElementById('handPositions').textContent = positionText;
  } else {
    document.getElementById('handPositions').textContent = 'None';
  }
  
  drawDetectionBoxes(handData);
  
  console.log(`[v0] Updated display - Count: ${handData.hand_count}, Confidence: ${handData.hand_confidence}%, Positions: ${handPositions.length}`);
}

function drawDetectionBoxes(handData) {
  const canvas = document.getElementById('detectionOverlay');
  const img = document.getElementById('yoloStream');
  const ctx = canvas.getContext('2d');
  
  canvas.width = img.clientWidth;
  canvas.height = img.clientHeight;
  
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  
  if (handData.hand_positions && handData.hand_positions.length > 0) {
    ctx.strokeStyle = '#00ff00';
    ctx.lineWidth = 3;
    ctx.font = '16px Roboto Mono';
    ctx.fillStyle = '#00ff00';
    
    handData.hand_positions.forEach((bbox, index) => {
      const [x1, y1, x2, y2] = bbox;
      
      const scaleX = canvas.width / 640;
      const scaleY = canvas.height / 480;
      
      const scaledX1 = x1 * scaleX;
      const scaledY1 = y1 * scaleY;
      const scaledX2 = x2 * scaleX;
      const scaledY2 = y2 * scaleY;
      
      ctx.strokeRect(scaledX1, scaledY1, scaledX2 - scaledX1, scaledY2 - scaledY1);
      
      const label = `Hand ${index + 1}`;
      ctx.fillText(label, scaledX1, scaledY1 - 5);
    });
  }
}

function updateStreamStatus() {
  const streamIndicator = document.getElementById('streamIndicator');
  const yoloStream = document.getElementById('yoloStream');
  
  yoloStream.onload = function() {
    streamIndicator.textContent = 'Stream: Active';
    streamIndicator.className = 'status detected';
    console.log('[v0] YOLO stream loaded successfully');
  };
  
  yoloStream.onerror = function() {
    streamIndicator.textContent = 'Stream: Error';
    streamIndicator.className = 'status unknown';
    console.log('[v0] YOLO stream failed to load');
  };
}

function displayIncidents(incidents) {
  const incidentsList = document.getElementById('incidentsList');
  
  if (incidents.length === 0) {
    incidentsList.innerHTML = '<p>No incidents recorded yet.</p>';
    return;
  }

  let html = '';
  incidents.forEach(incident => {
    const confidence = Math.round(incident.confidence);
    const timestamp = new Date(incident.timestamp).toLocaleString();
    let confidenceClass = 'low-confidence';
    
    if (confidence >= 80) confidenceClass = 'high-confidence';
    else if (confidence >= 60) confidenceClass = 'medium-confidence';

    html += `
      <div class="incident-item ${confidenceClass}">
        <h4>üö® Security Alert - ${confidence}% Confidence</h4>
        <p><strong>Time:</strong> ${timestamp}</p>
        <p><strong>Explanation:</strong> ${incident.explanation || 'No details available'}</p>
        <p><strong>Status:</strong> ${incident.resolved ? 'Resolved' : 'Active'}</p>
      </div>
    `;
  });

  incidentsList.innerHTML = html;
}

setInterval(refreshData, 2000);

refreshData();
updateStreamStatus();
</script>
{% endblock %}
